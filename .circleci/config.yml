version: 2.1

orbs:
  node: circleci/node@5.2.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.12

jobs:
  # This job's ONLY purpose is to verify file paths before starting the server.
  debug_file_paths:
    executor: node-executor
    steps:
      - checkout
      
      - run:
          name: Check File System Before Server Start
          command: |
            echo "--- Verifying project structure from the root ---"
            ls -la
            
            echo "\n--- Changing directory to backend ---"
            cd backend
            
            echo "\n--- Verifying structure inside backend directory ---"
            pwd
            ls -la
            
            echo "\n--- Checking for keys folder ---"
            if [ -d "keys" ]; then
              echo "✓ 'keys' directory exists."
              ls -la keys
            else
              echo "✗ FATAL: 'keys' directory does NOT exist inside 'backend'."
              exit 1
            fi

            echo "\n--- Attempting to read privatekey.pem ---"
            if [ -f "keys/privatekey.pem" ]; then
              echo "✓ 'keys/privatekey.pem' exists."
              # Try to read the first line of the file. If this fails, we have a permissions issue.
              head -n 1 keys/privatekey.pem
            else
              echo "✗ FATAL: 'keys/privatekey.pem' does NOT exist."
              exit 1
            fi
            
            echo "\n✓✓✓ All path checks passed. The server should be able to find its key files."

workflows:
  debug-workflow:
    jobs:
      - debug_file_paths