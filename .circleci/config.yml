version: 2.1

orbs:
  node: circleci/node@5.2.0
  sonarcloud: sonarsource/sonarcloud@2.0.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.12

jobs:
  # ---------------------------------------------
  # JOB 1: Static Code Analysis with SonarCloud
  # ---------------------------------------------
  sonar_scan:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Install All Project Dependencies
          command: |
            npm install --prefix backend
            npm install --prefix frontend
            npm install --prefix employee-portal
      - run:
          name: Create SonarCloud configuration file
          command: |
            echo "sonar.projectKey=${SONAR_PROJECT_KEY}" > sonar-project.properties
            echo "sonar.organization=${SONAR_ORGANIZATION}" >> sonar-project.properties
            echo "sonar.sources=backend,frontend/src,employee-portal/src" >> sonar-project.properties
            echo "sonar.exclusions=**/node_modules/**,**/build/**,**/*.test.js,**/*.spec.js" >> sonar-project.properties
      - sonarcloud/scan

  # ---------------------------------------------
  # JOB 2: API Security Testing
  # ---------------------------------------------
  api_test:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix backend
            
      - run:
          name: Start Server in Background (Wait 5s for full boot)
          command: |
            # 1. Run the server from the 'backend' directory.
            # 2. Redirect stdout/stderr to a log file for debugging.
            cd backend
            npm start > /tmp/server.log 2>&1 &
            echo $! > /tmp/server_pid # Save PID
            sleep 5 # Give the server a few extra seconds to boot up and connect to MongoDB
          background: true
          
      - run:
          name: Wait for Server to be UP (Check with 'curl -k')
          command: |
            echo "Checking server status (max 20 attempts)..."
            for i in $(seq 1 20); do
              # We must use -k because the certificate is self-signed (insecure, but needed for CI)
              # The --silent (-s) flag is used to hide progress
              # The --fail (-f) flag makes curl exit with a non-zero code on 4xx/5xx errors
              STATUS=$(curl -sk -o /dev/null -w "%{http_code}" https://127.0.0.1:3000/ 2>> /tmp/curl_errors)
              
              if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 500 ]; then 
                echo "âœ“ Server is UP! Responded with status: $STATUS"
                exit 0
              fi
              
              echo "Attempt $i/20: Server not ready (Status: $STATUS). Waiting 3 seconds..."
              sleep 3
            done
            
            # --- FAILURE BLOCK ---
            echo "---------------------------------------------------------"
            echo "FAIL: Server did not start in time. LAST KNOWN STATUS: $STATUS"
            echo "---------------------------------------------------------"
            echo "SERVER LOG (backend/npm start output):"
            cat /tmp/server.log
            echo "---------------------------------------------------------"
            echo "CURL ERRORS (Network/SSL issues):"
            cat /tmp/curl_errors
            echo "---------------------------------------------------------"
            kill $(cat /tmp/server_pid) # Attempt to kill the stuck server
            exit 1
            
      - run:
          name: Test Login Rate Limiter
          command: |
            # ... (rest of your curl commands)
            # MAKE SURE ALL CURL COMMANDS STILL USE https://127.0.0.1:3000 AND THE -k FLAG
            
      - run:
          name: Clean up background processes
          when: always
          command: kill $(cat /tmp/server_pid)
# ---------------------------------------------
# WORKFLOWS
# ---------------------------------------------
workflows:
  build-and-test:
    jobs:
      - sonar_scan:
          context:
            - project-secrets 
      - api_test:
          context:
            - project-secrets
          requires:
            - sonar_scan