version: 2.1

orbs:
  node: circleci/node@5.2.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.12

jobs:
  # A temporary job to debug the server startup process
  debug_server_startup:
    executor: node-executor
    steps:
      - checkout
      
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix backend
      
      - run:
          name: Verify Environment Variables
          command: |
            echo "Verifying environment variables..."
            if [ -z "$ATLAS_URI" ]; then echo "✗ ATLAS_URI is missing!"; else echo "✓ ATLAS_URI is set."; fi
            if [ -z "$JWT_SECRET" ]; then echo "✗ JWT_SECRET is missing!"; else echo "✓ JWT_SECRET is set."; fi
            # ... add other checks if needed

      - run:
          name: Attempt to Start Server in Foreground
          command: |
            echo "Attempting to start the backend server..."
            cd backend
            node server.mjs

workflows:
  debug-workflow:
    jobs:
      - debug_server_startup:
          context:
            - project-secrets