version: 2.1

orbs:
  node: circleci/node@5.2.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.12

jobs:
  # This temporary job will run the server in the foreground to get the real error message.
  debug_server_startup:
    executor: node-executor
    steps:
      - checkout
      
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix backend
      
      # This step will now fail with the actual Node.js error message.
      - run:
          name: Attempt to Start Server in Foreground
          command: |
            echo "Attempting to start the backend server in the foreground..."
            cd backend
            # We run the server directly. If it crashes, the error will print here.
            node server.mjs

workflows:
  debug-workflow:
    jobs:
      - debug_server_startup:
          context:
            - project-secrets # This is still needed for ATLAS_URI etc.