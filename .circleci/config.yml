version: 2.1

orbs:
  node: circleci/node@5.2.0
  sonarcloud: sonarsource/sonarcloud@2.0.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.12

jobs:
  # ---------------------------------------------
  # JOB 1: Static Code Analysis with SonarCloud
  # ---------------------------------------------
  sonar_scan:
    executor: node-executor
    steps:
      - checkout
      
      # 1. Install dependencies for ALL parts of the project.
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix backend
      - run:
          name: Install Customer Portal Dependencies
          command: npm install --prefix frontend
      - run:
          name: Install Employee Portal Dependencies
          command: npm install --prefix employee-portal

      # 2. Configure Sonar Scanner via a properties file.
      # FIX: Added sonar.projectKey and sonar.organization, which were mandatory and missing.
      - run:
          name: Generate sonar-project.properties
          command: |
            echo "sonar.projectBaseDir=." > sonar-project.properties
            echo "sonar.projectKey=EthanParsons99_st10299399_INSY7314_Security" >> sonar-project.properties
            echo "sonar.organization=ethanparsons99" >> sonar-project.properties
            echo "sonar.language=js" >> sonar-project.properties
            echo "sonar.sources=backend,frontend/src,employee-portal/src" >> sonar-project.properties
            echo "sonar.exclusions=**/node_modules/**,**/build/**,**/*.test.js,**/*.spec.js" >> sonar-project.properties
      
      # 3. Run the SonarCloud Analysis
      - sonarcloud/scan
          # NOTE: No arguments are passed here. The orb will automatically detect and use
          # the 'sonar-project.properties' file generated in the previous step.

  # ---------------------------------------------
  # JOB 2: API Security Testing
  # ---------------------------------------------
  api_test:
    executor: node-executor
    steps:
      - checkout
      
      # Install dependencies only for the backend, as we are only testing the API
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix backend
      
      # Start the backend server in the background
      - run:
          name: Start Backend Server
          command: |
            cd backend
            # Note: For this to work, you MUST add ATLAS_URI, JWT_SECRET, EMPLOYEE_USERNAME,
            # and EMPLOYEE_PASSWORD as Environment Variables in your CircleCI Project Settings.
            # Using npm start if package.json has a start script, or node server.mjs
            node server.mjs &
          background: true
          
      # ðŸš¨ FIX: Replaced 'sleep 15' with a robust polling loop. ðŸš¨
      - run:
          name: Wait for Server to Be Accessible
          command: |
            # Use 127.0.0.1 for reliable container networking
            SERVER_URL="https://127.0.0.1:3000"
            MAX_ATTEMPTS=10
            ATTEMPT=1
            
            echo "Waiting for backend server at $SERVER_URL to start..."
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              # curl -s (silent), -k (insecure/skip cert), -f (fail fast on HTTP error)
              # Check if the connection succeeds (status code 000 is for connection success)
              if curl -skf --head $SERVER_URL; then
                echo "Server is UP and responsive after $ATTEMPT attempts."
                exit 0 # Success
              fi
              
              echo "Attempt $ATTEMPT of $MAX_ATTEMPTS failed. Sleeping for 3 seconds..."
              sleep 3
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo "FAIL: Server did not become responsive after $MAX_ATTEMPTS attempts."
            exit 1 # Failure
      
      # Test 1: Rate Limiter (Brute-Force/DDoS Protection)
      - run:
          name: Test Login Rate Limiter (Expecting 6th attempt to fail with 429)
          command: |
            echo "--- Testing Rate Limiter ---"
            LOGIN_DATA='{"name": "adminuser", "password": "Admin@1234"}'
            # FIX: Change localhost to 127.0.0.1 for reliable connectivity inside the Docker container
            LOGIN_URL="https://127.0.0.1:3000/user/login"
            
            # Attempt login 6 times (your rate limit is 5)
            # Use 'for i in $(seq 1 6); do' for better cross-shell compatibility in CircleCI
            for i in $(seq 1 6); do
              STATUS_CODE=$(curl --insecure -s -o /dev/null -w "%{http_code}" $LOGIN_URL -H "Content-Type: application/json" -d "$LOGIN_DATA")
              echo "Attempt $i: Status Code $STATUS_CODE"
              if [ "$i" -eq 6 ] && [ "$STATUS_CODE" -ne 429 ]; then
                echo "FAIL: Rate limiter did not return 429 on 6th attempt. Got $STATUS_CODE."
                exit 1
              fi
            done
            echo "SUCCESS: Rate limiter passed."
          
      # Test 2: Employee Endpoint Authorization (Role-Based Access Control)
      - run:
          name: Test Employee Endpoint Authorization (Unauthenticated)
          command: |
            # FIX: Change localhost to 127.0.0.1 for reliable connectivity inside the Docker container
            EMPLOYEE_URL="https://127.0.0.1:3000/employee/payments"
            UNAUTH_STATUS=$(curl --insecure -s -o /dev/null -w "%{http_code}" $EMPLOYEE_URL)
            if [ "$UNAUTH_STATUS" -ne 401 ]; then
              echo "FAIL: Unauthenticated access to $EMPLOYEE_URL returned $UNAUTH_STATUS (Expected 401)."
              exit 1
            fi
            echo "SUCCESS: Employee endpoint correctly denies unauthorized access."
            
# ---------------------------------------------
# WORKFLOWS: Define the order of jobs
# ---------------------------------------------
workflows:
  build-and-test:
    jobs:
      - sonar_scan
      - api_test:
          requires:
            - sonar_scan