# .circleci/config.yml

version: 2.1

# Use the official SonarSource orb and a modern Node orb
orbs:
  node: circleci/node@5.2.0
  sonarcloud: sonarsource/sonarcloud@2.0.0 

executors:
  node-executor:
    docker:
      - image: cimg/node:20.12 # Using a stable LTS Node.js version

jobs:
  # ---------------------------------------------
  # JOB 1: Static Code Analysis with SonarCloud
  # ---------------------------------------------
  sonar_scan:
    executor: node-executor
    steps:
      - checkout
      
      # Install dependencies for all parts of the project
      - run:
          name: Install All Project Dependencies
          command: |
            npm install --prefix backend
            npm install --prefix frontend
            npm install --prefix employee-portal
      
      # Run the SonarCloud Analysis
      - sonarcloud/scan:
          # --- SYNTAX CORRECTION ---
          # The 'properties' parameter is deprecated. The new, correct parameter is 'extra_args'.
          # We are passing the same sonar properties, just using the new syntax.
          extra_args: >-
            -Dsonar.sources=backend,frontend/src,employee-portal/src
            -Dsonar.tests=frontend/src,employee-portal/src
            -Dsonar.test.inclusions=/.test.js,/.spec.js
            -Dsonar.exclusions=/node_modules/,/build/,/coverage/,/.spec.js,/.test.js

  # ---------------------------------------------
  # JOB 2: API Security Testing
  # ---------------------------------------------
  api_test:
    executor: node-executor
    steps:
      - checkout
      
      # Install backend dependencies
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix backend
      
      # Start the backend server
      - run:
          name: Start Backend Server
          command: |
            cd backend
            # Note: This job requires ATLAS_URI, JWT_SECRET, EMPLOYEE_USERNAME,
            # and EMPLOYEE_PASSWORD to be set as CircleCI Environment Variables.
            node server.mjs &
          background: true
          
      - run: 
          name: Wait for Server to Start
          command: sleep 15
      
      # Test 1: Rate Limiter
      - run:
          name: Test Login Rate Limiter (Expecting 6th attempt to fail with 429)
          command: |
            echo "--- Testing Rate Limiter ---"
            LOGIN_DATA='{"name": "adminuser", "password": "Admin@1234"}'
            LOGIN_URL="https://localhost:3000/user/login"
            
            for i in {1..6}; do
              STATUS_CODE=$(curl --insecure -s -o /dev/null -w "%{http_code}" $LOGIN_URL -H "Content-Type: application/json" -d "$LOGIN_DATA")
              echo "Attempt $i: Status Code $STATUS_CODE"
              if [ "$i" -eq 6 ] && [ "$STATUS_CODE" -ne 429 ]; then
                echo "FAIL: Rate limiter did not return 429 on 6th attempt. Got $STATUS_CODE."
                exit 1
              fi
            done
            echo "SUCCESS: Rate limiter passed."
          
      # Test 2: Employee Endpoint Authorization
      - run:
          name: Test Employee Endpoint Authorization (Unauthenticated)
          command: |
            EMPLOYEE_URL="https://localhost:3000/employee/payments"
            UNAUTH_STATUS=$(curl --insecure -s -o /dev/null -w "%{http_code}" $EMPLOYEE_URL)
            if [ "$UNAUTH_STATUS" -ne 401 ]; then
              echo "FAIL: Unauthenticated access to $EMPLOYEE_URL returned $UNAUTH_STATUS (Expected 401)."
              exit 1
            fi
            echo "SUCCESS: Employee endpoint correctly denies unauthorized access."
            
# ---------------------------------------------
# WORKFLOWS
# ---------------------------------------------
workflows:
  build-and-test:
    jobs:
      - sonar_scan
      - api_test:
          requires:
            - sonar_scan